<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--客户映射 指定到dao接口 -->
<mapper namespace="com.park.ssm.dao.BillDao">
	<!-- <resultMap type="bill" id="billResultMap"> <id property="id" column="userId"></id> 
		<result property="billStartDate" column="billStartDate"></result> <result 
		property="billEndDate" column="billStartDate"></result> <result property="price" 
		column="price"></result> <result property="isPaid" column="isPaid"></result> 
		<association property="user" javaType="User"> <id property="id" column="userId"/> 
		</association> <association property="parkingLot" javaType="ParkingLot"> 
		<id property="id" column="parkingLotId"/> </association> <association property="account" 
		javaType="Account"> <id property="id" column="accountId"/> </association> 
		</resultMap> -->
	<sql id="sqlField">
		id,userId,parkingLotId,accountId,price,isPaid
		</sql>
	<resultMap type="bill" id="billResultMap">
		<id property="id" column="userId"></id>
		
		<result property="userId" column="userId"/>
		<result property="parkingLotId" column="parkingLotId"/>
		<result property="accountId" column="accountId"/>

		<result property="price" column="price"/>
		<result property="isPaid" column="isPaid"/>
		<result property="lastPayDate" column="lastPayDate"/>
		
		<collection property="timeQuantums" >
			<result property="startTime" column="startTime"/>
			<result property="endTime" column="endTime"/>
		</collection>
	</resultMap>
	
	<sql id="billField">
		id
		,userId,parkingLotId,accountId
		,price,isPaid,lastPayDate
	</sql>
	<sql id="timeQuantumField">
		startTime,endTime
	</sql>

	<!-- 通过id加载账单 -->
	<select id="loadBillById" parameterType="Long" resultType="Bill">
		select
		<include refid="sqlField" />
		from Bill
		where id=#{_parameter}
	</select>
	<select id="loadBillByIdForUpdate" parameterType="Long"
		resultType="Bill">
		select
		<include refid="sqlField" />
		from Bill
		where id=#{_parameter}
		for update
	</select>

	<!-- 通过各種id組合加载账单 -->
	<select id="listBillById" resultType="Bill">
		select
		<include refid="sqlField" />
		from Bill
		<where>
			<if test="userId != null">
				and userId=#{userId}
			</if>
			<if test="accountId != null">
				and accountId=#{accountId}
			</if>
			<if test="parkingLotId != null">
				and parkingLotId=#{parkingLotId}
			</if>
		</where>
		<if test="pageNum != null and pageSize != null">
			limit ${(pageNum-1)*pageSize},#{pageSize}
		</if>
	</select>
	<select id="countBillById" parameterType="Long" resultType="Integer">
		select
		count(1)
		from Bill
		<where>
			<if test="userId != null">
				and user=#{userId}
			</if>
			<if test="accountId != null">
				and accountId=#{accountId}
			</if>
			<if test="parkingLotId != null">
				and parkingLotId=#{parkingLotId}
			</if>
		</where>
	</select>

	<update id="updateBillStateById">
		update Bill
		set isPaid=1
		where id=#{_parameter}
	</update>

	<select id="isNotPayBill" parameterType="Long" resultType="Integer">
		select count(id) from Bill
		<where>
			<if test="userId != null">
				and userId=#{userId}
			</if>
				<if test="parkingLotId != null">
				and parkingLotId=#{parkingLotId}
			</if>
		</where>
		and isPaid=0
	</select>
	<select id="listBillByCardId" resultType="com.park.ssm.entity.Bill">
		select

		b.id,b.userId,b.lastPayDate,b.price,b.isPaid
		from Account a,Bill b
		<where> b.userId=a.userId
			and a.cardId=#{cardId}
		</where>
	</select>
	
	<insert id="addBill" parameterType="com.park.ssm.entity.Bill">
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			<!-- SELECT LAST_INSERT_ID()：获取刚insert到数据表中的记录的键值，只适用于自增键字段 -->
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into
		Bill(userId,parkingLotId,accountId,price,isPaid)
		values(#{userId},#{parkingLotId},#{accountId},#{price},#{isPaid})
	</insert>
	<update id="updateIsPaid" >
	update Bill set isPaid=#{isPaid}
	where id=#{id}
	</update>
</mapper>